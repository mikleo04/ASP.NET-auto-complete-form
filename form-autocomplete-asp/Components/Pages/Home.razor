@page "/"

<PageTitle>Home</PageTitle>

<div class="row">
    <div class="col-lg-5 mx-auto rounded border p-3">
        <h2 class="text-center mb-5">Autocomplete Form</h2>
        
        <form method="post">
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label ">Negara</label>
                <div class="col-sm-8">
                    <input class="form-control" asp-for="Negara" type="text" id="countryInput" name="countryInput"/>
                    <span asp-validation-for="Negara" class="text-danger"></span>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label ">Pelabuhan</label>
                <div class="col-sm-8">
                    <input class="form-control" asp-for="Pelabuhan" type="text" id="pelabuhanInput" name="pelabuhanInput"/>
                    <span asp-validation-for="Pelabuhan" class="text-danger"></span>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label">Barang</label>
                <div class="col-sm-8">
                    <input class="form-control" asp-for="Barang" type="text" id="barang" name="barang"/>
                    <span asp-validation-for="Barang" class="text-danger"></span>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label "></label>
                <div class="col-sm-8">
                    <textarea class="form-control" asp-for="DetailBarang" id="detailBarang" name="detailBarang"></textarea>
                    <span asp-validation-for="DetailBarang" class="text-danger"></span>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label ">Harga</label>
                <div class="col-sm-8">
                    <input class="form-control" type="number" asp-for="Harga" id="harga" name="harga"/>
                    <span asp-validation-for="Harga" class="text-danger"></span>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label ">Tarif Bea Masuk</label>
                <div class="col-sm-7">
                    <input class="form-control" asp-for="TarifBeaMasuk" id="tarif" name="tarif"/>
                    <span asp-validation-for="TarifBeaMasuk" class="text-danger"></span>
                </div>
                <span class="col-sm-1">%</span>
            </div>
            <div class="row mb-3">
                <label class="col-sm-4 col-form-label "></label>
                <div class="col-sm-8">
                    <input class="form-control" asp-for="Result" id="result" name="result"/>
                    <span asp-validation-for="Result" class="text-danger"></span>
                </div>
            </div>
            <div class="row">
                <div class="offset-sm-4 col-sm-8">
                    <button type="submit" class="btn btn-primary">
                        Submit
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        let kd_negara;
        const BASE_URL = "http://localhost:3000";
        $("#countryInput").autocomplete({
            source: function (request, response) {
              const input = request.term;
              console.log(input);
             
            $.ajax({
              url: `${BASE_URL}/negara?ur_negara=${encodeURIComponent(input)}`,
              type: "GET",
              dataType: "json",
              success: function (data) {
                const suggestions = [];
                $.each(data, function (index, country) {
                  suggestions.push({value: country.name});
                  kd_negara = country.kd_negara;
                });
                response(suggestions);
              },
              error: function (xhr, status, error) {
                console.error("Error fetching countries:", error);
              }
            });
            },
            minLength: 3,
            select: function (event, ui) {
              $("#countryInput").val(ui.item.value);
              return false;
            }
        });
        
        $("#pelabuhanInput").autocomplete({
            source: function (request, response) {
              const input = request.term;
             
            $.ajax({
              url: `${BASE_URL}/pelabuhan?kd_negara=${encodeURIComponent(kd_negara)}&ur_pelabuhan=${encodeURIComponent(input)}`,
              type: "GET",
              dataType: "json",
              success: function (data) {
                const suggestions = [];
                $.each(data, function (index, harbor) {
                  suggestions.push({ value: harbor.ur_pelabuhan });
                });
                response(suggestions);
              },
              error: function (xhr, status, error) {
                console.error("Error fetching countries:", error);
              }
            });
            },
            minLength: 3,
            select: function (event, ui) {
              $("#pelabuhanInput").val(ui.item.value);
              return false;
            }
        });
        
        $("#barang").on("input", function () {
            const inputValue = $(this).val();
            if (inputValue) {
                $.ajax({
                    url: `${BASE_URL}/barang?hs_code=${encodeURIComponent(inputValue)}`,
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        let detailBarang;
                        $.each(data, function (index, item) {
                          detailBarang = item.details;
                        });
                        const detailBarangValue = detailBarang.join('\n');
                        $("#detailBarang").val(detailBarangValue);
                    },
                    error: function (xhr, status, error) {
                        console.log("Error fetching detail barang", error);
                    }
                });
            }
        });     
    });
</script>